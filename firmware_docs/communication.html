<!-- HTML header for doxygen 1.8.16-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="shortcut icon" href="faviconMRE2.png" type="image/x-icon" />
<title>MR-E-2: Communication</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="https://www.optotune.com/" target="_blank"><img alt="Logo" src="optotune_logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MR-E-2
   &#160;<span id="projectnumber">138-161-00</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Communication</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The serial communication is always in one of two modes &ndash; <b>simple</b> mode or <b>pro</b> mode. In each of these modes, a different set of commands is supported. The default mode active on startup is simple mode. Brief descriptions of the commands available in each mode follow. To see a description of the pro mode error codes, see <a class="el" href="Error.html">Error Codes</a>.</p>
<p>Simple mode:</p>
<p>Simple mode is ASCII-based - every command is a sequence of ASCII characters. Every simple mode message (that is, every command to the firmware and every response from the firmware) should end in the sequence CR LF ("\r\n"), that is, two bytes with decimal values 13 and 10. The protocol is not case sensitive and all whitespace is ignored.</p>
<p>Simple mode commands:</p>
<ul>
<li>start &ndash; returns "OK", just a simple handshake command to confirm that the communication is working</li>
<li>status &ndash; returns the status register in hex format, which encodes the status and erros of the device. See <a class="el" href="Status.html">Status</a></li>
<li>acknowledge &ndash; clears history error flags in the status register. See <a class="el" href="Status.html">Status</a></li>
<li>reset &ndash; resets the device</li>
<li>gopro &ndash; switches the serial communication to pro mode with CRC turned off</li>
<li>goprocrc &ndash; switches the serial communication to pro mode with CRC turned on</li>
<li>currentx = <em>float</em> mA &ndash; drive channel x with a current of <em>float</em> milliamperes, <em>float</em> should be in the range (-700.0, 700.0)</li>
<li>currenty = <em>float</em> mA &ndash; drive channel y with a current of <em>float</em> milliamperes, <em>float</em> should be in the range (-700.0, 700.0)</li>
<li>pidofx = <em>float</em> &ndash; drive channel x with a PID with a target optical feedback of <em>float</em> </li>
<li>pidofy = <em>float</em> &ndash; drive channel y with a PID with a target optical feedback of <em>float</em> </li>
<li>pidofxy = <em>floatx</em>; <em>floaty</em> &ndash; drive channels x and y with a PID with target optical feedbacks of <em>floatx</em> and <em>floaty</em>, respectively</li>
<li>x = <em>float</em> &ndash; drive channel x to achieve calibrated X of <em>float</em>, <em>float</em> should be in the range (-1.0, 1.0)</li>
<li>y = <em>float</em> &ndash; drive channel y to achieve calibrated Y of <em>float</em>, <em>float</em> should be in the range (-1.0, 1.0)</li>
<li>xy = <em>floatx</em>; <em>floaty</em> &ndash; drive channels x and y to achieve calibrated XY of <em>floatx</em> and <em>floaty</em>, respectively</li>
<li>getid &ndash; get the firmware serial number</li>
<li>getversion &ndash; get the firmware version number</li>
<li>getsn &ndash; get the serial number of the board and the device</li>
<li>getgitsha1 &ndash; get the latest git commit hash value (to help identify the specific build)</li>
<li>gotodfu &ndash; go to DFU mode</li>
</ul>
<p>Simple mode responses:</p>
<ul>
<li>OK &ndash; confirmation that the command was understood and performed</li>
<li>ERROR &ndash; Response of status command if there is an active error. Type status to get the status register.</li>
<li>NO &ndash; invalid command</li>
<li>OU &ndash; "out of range upper", value too high</li>
<li>OL &ndash; "out of range lower", value too low</li>
</ul>
<p>Pro mode:</p>
<p>Pro mode is a byte-based protocol inspired by HDLC. Individual messages are delimited with the "delimiter" byte, 0x7e. To avoid the delimiter byte appearing in the message data, an "escape byte", 0x7d, is also used, and byte stuffing is performed on every message before being sent out (so the receiver should then perform byte destuffing) as follows: Every appearance of the bytes 0x7e or 0x7d in the data (so in a role other than the delimiter or the escape byte) is replaced by the sequence 0x7d 0x5e or 0x7d 0x5d, respectively. In other words, every byte that needs to be escaped is escaped by being XORed with 0x20 and prepended with 0x7d. When destuffing, every instance of 0x7d should be treated as an escape byte - it should not be interpreted as a data byte, it only marks that the following byte should be XORed with 0x20 before being interpreted as another data byte.</p>
<p>Above the delimiting and stuffing layer, every pro mode message has the following format:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Reserved (slave address)   </th><th class="markdownTableHeadNone">Command   </th><th class="markdownTableHeadNone">Data size   </th><th class="markdownTableHeadNone">Data (payload)   </th><th class="markdownTableHeadNone">CRC    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1 byte   </td><td class="markdownTableBodyNone">1 byte   </td><td class="markdownTableBodyNone">1 byte   </td><td class="markdownTableBodyNone">0 - 50 bytes   </td><td class="markdownTableBodyNone">2 bytes   </td></tr>
</table>
<p>The semantics of the individual fields are as follows:</p>
<ul>
<li>Slave address &ndash; this field is currently unused</li>
<li>Command &ndash; a 1-byte unique identifier of the selected command (see below)</li>
<li>Data size &ndash; the number of bytes in the following data field</li>
<li>Data &ndash; the data required by the command / response, limited to 50 bytes</li>
<li>CRC &ndash; the CRC checksum, present even if CRC is deactivated (the values can be ignored in that case)</li>
</ul>
<p>Available commands:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Command name   </th><th class="markdownTableHeadNone">Code   </th><th class="markdownTableHeadNone">Command payload   </th><th class="markdownTableHeadNone">Response payload   </th><th class="markdownTableHeadNone">Note    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Generic command   </td><td class="markdownTableBodyNone">0x00   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">Used for special purposes, such as error responses to commands with unclear command code    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Get firmware identification   </td><td class="markdownTableBodyNone">0x01   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">32bits firmware ID   </td><td class="markdownTableBodyNone">N/A    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Get status   </td><td class="markdownTableBodyNone">0x02   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">32bits status register   </td><td class="markdownTableBodyNone">N/A    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Start self-test   </td><td class="markdownTableBodyNone">0x03   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">N/A    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Load configuration   </td><td class="markdownTableBodyNone">0x04   </td><td class="markdownTableBodyNone">1 byte snapshot id   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">3 snapshots are available. 0 is the factory snapshot id.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Store configuration   </td><td class="markdownTableBodyNone">0x05   </td><td class="markdownTableBodyNone">1 byte snapshot id   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">3 snapshots are available. Factory snapshot is read only. 2 and 3 can be stored by the user    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Set communication mode   </td><td class="markdownTableBodyNone">0x06   </td><td class="markdownTableBodyNone">1 byte mode   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">0 for simple mode, unchanged otherwise    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Set value   </td><td class="markdownTableBodyNone">0x10   </td><td class="markdownTableBodyNone">2 bytes register id, 4 bytes value   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">see <a class="el" href="architecture.html">Architecture</a> for explanation of Systems and registers    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Get value   </td><td class="markdownTableBodyNone">0x11   </td><td class="markdownTableBodyNone">2 bytes register id   </td><td class="markdownTableBodyNone">4 bytes register value   </td><td class="markdownTableBodyNone">see <a class="el" href="architecture.html">Architecture</a> for explanation of Systems and registers    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Set multiple values   </td><td class="markdownTableBodyNone">0x12   </td><td class="markdownTableBodyNone">2 bytes value count = CNT, 2xCNT bytes register ids, 4xCNT bytes register values   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">see <a class="el" href="architecture.html">Architecture</a> for explanation of Systems and registers    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Get multiple values   </td><td class="markdownTableBodyNone">0x13   </td><td class="markdownTableBodyNone">2 bytes value count = CNT, 2xCNT bytes register ids   </td><td class="markdownTableBodyNone">2 bytes value count = CNT, 4xCNT bytes register values   </td><td class="markdownTableBodyNone">see <a class="el" href="architecture.html">Architecture</a> for explanation of Systems and registers    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Set vector   </td><td class="markdownTableBodyNone">0x14   </td><td class="markdownTableBodyNone">2 bytes vector id, 2 bytes index, 1 byte length = SIZE, SIZE bytes data   </td><td class="markdownTableBodyNone">empty   </td><td class="markdownTableBodyNone">see <a class="el" href="architecture.html">Architecture</a> for explanation of Systems and vectors; SIZE bytes starting at the index given are rewritten    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Get vector   </td><td class="markdownTableBodyNone">0x15   </td><td class="markdownTableBodyNone">2 bytes vector id, 2 bytes index, 1 byte length = SIZE   </td><td class="markdownTableBodyNone">SIZE bytes data   </td><td class="markdownTableBodyNone">see <a class="el" href="architecture.html">Architecture</a> for explanation of Systems and vectors; SIZE bytes starting at the index given are read   </td></tr>
</table>
<p>Responses:</p>
<p>Responses have the same format as the commands (possibly with different payload data, see above) with the command code of the response corresponding to the command code of the command being responded to. However, error responses are marked by the most significant bit being set in the command code (in other words, an 0x80 is added to the command code), and the payload should consist of a single 4 byte error flag, see <a class="el" href="Error.html">Error Codes</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<hr class="footer"/><address class="footer"><small>
<a href="https://www.optotune.com/" target="_blank">Optotune. All rights reserved. 
</a>
</small></address>
</body>
</html>
